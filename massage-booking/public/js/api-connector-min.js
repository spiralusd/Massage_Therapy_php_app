/**
 * Massage Booking API Connector - Minimized Version
 * Version: 1.1.0
 */
(function($){$(document).ready(function(){console.log("Massage Booking API Connector initialized");const t=document.getElementById("appointmentForm");if(!t){console.error('Appointment form not found with ID "appointmentForm"');console.log("Trying alternative selectors...");const e=document.querySelectorAll("form.booking-form, .massage-booking-container form, .booking-form-container form");if(e.length>0){console.log("Found alternative form:",e[0]);e[0].id="appointmentForm";r(e[0])}else{console.error("No booking form found on page. Cannot initialize booking system.");const t=document.querySelectorAll(".massage-booking-container, .booking-container, .booking-form-container");if(t.length>0){const e=document.createElement("div");e.style.color="red";e.style.padding="15px";e.style.border="1px solid red";e.style.marginTop="20px";e.innerHTML="<strong>Error:</strong> Booking form not found. Please check plugin installation.";t[0].appendChild(e)}}}else{r(t)}function r(t){if(typeof massageBookingAPI==="undefined"){console.error("WordPress API data not available");o("API configuration missing. Please check plugin settings.");return}const r={settings:null,slots:{},getSettings:function(){return this.settings},setSettings:function(e){this.settings=e;return e},getSlots:function(e,t){const r=`${e}-${t}`;return this.slots[r]},setSlots:function(e,t,r){const n=`${e}-${t}`;this.slots[n]=r;return r},clearCache:function(){this.settings=null;this.slots={}}};const n=function(){const e=document.createElement("div");e.className="api-loading";e.innerHTML='\n                <div class="loading-spinner"></div>\n                <p>Processing...</p>\n            ';if(!document.getElementById("api-loading-styles")){const t=document.createElement("style");t.id="api-loading-styles";t.textContent=".api-loading{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255, 255, 255, 0.8);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999}.loading-spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #4a6fa5;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:10px}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}";document.head.appendChild(t)}return e};const a=function(){const e=n();document.body.appendChild(e);return e};const i=function(e){if(e&&e.parentNode){e.parentNode.removeChild(e)}};const s=function(e,t="An error occurred"){console.error(e);const r=document.createElement("div");r.className="api-error";r.innerHTML=`\n                <p><strong>Error:</strong> ${t}</p>\n                <p>${e.message||"Please try again or contact support."}</p>\n                <button class="dismiss-error">Dismiss</button>\n            `;if(!document.getElementById("api-error-styles")){const e=document.createElement("style");e.id="api-error-styles";e.textContent=".api-error{position:fixed;top:20px;right:20px;max-width:300px;background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;border-radius:4px;padding:15px;z-index:9999;box-shadow:0 2px 10px rgba(0, 0, 0, 0.1)}.dismiss-error{background:#721c24;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-top:10px}";document.head.appendChild(e)}r.querySelector(".dismiss-error").addEventListener("click",function(){if(r.parentNode){r.parentNode.removeChild(r)}});setTimeout(function(){if(r.parentNode){r.parentNode.removeChild(r)}},1e4);document.body.appendChild(r);return false};const o=function(e){const r=document.createElement("div");r.className="form-error-message";r.innerHTML=`<p><strong>Error:</strong> ${e}</p>`;if(t.firstChild){t.insertBefore(r,t.firstChild)}else{t.appendChild(r)}setTimeout(()=>{if(r.parentNode){r.parentNode.removeChild(r)}},1e4)};const c=async function(e){try{const t=await fetch(massageBookingAPI.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"generate_booking_nonce",booking_action:e,_wpnonce:massageBookingAPI.nonce})});if(!t.ok){throw new Error("Failed to generate nonce")}const r=await t.json();return r.success?r.data.nonce||"":""}catch(e){console.error("Error generating nonce:",e);return""}};const l=async function(){try{const e=r.getSettings();if(e){return e}const t=a();const n=await fetch(massageBookingAPI.restUrl+"settings",{method:"GET",headers:{"X-WP-Nonce":massageBookingAPI.nonce,Accept:"application/json"}});if(!n.ok){throw new Error(`Failed to load settings (HTTP ${n.status})`)}const o=await n.json();console.log("Settings loaded from WordPress:",o);r.setSettings(o);if(o.working_days){const e=document.getElementById("appointmentDate");if(e){e.setAttribute("data-available-days",o.working_days.join(","));const t={0:"Sunday",1:"Monday",2:"Tuesday",3:"Wednesday",4:"Thursday",5:"Friday",6:"Saturday"};const r=o.working_days.map(e=>t[e]).join(", ");const n=document.querySelector("#appointmentDate + small");if(n){n.textContent="Available days: "+r}}}if(o.durations){const e=document.querySelectorAll(".radio-option");e.forEach(e=>{const t=e.getAttribute("data-value");if(!o.durations.includes(t)){e.style.display="none"}else{e.style.display="block";if(o.prices&&o.prices[t]){const r=e.querySelector(".price");if(r){r.textContent=" + settings.prices[t];"}}}})}if(o.break_time){const e=document.querySelector(".privacy-notice p");if(e){e.innerHTML=e.innerHTML.replace(/\d+-minute break/,o.break_time+"-minute break")}}if(typeof window.disableUnavailableDays==="function"){window.disableUnavailableDays()}if(typeof window.setAvailableDays==="function"){window.setAvailableDays()}i(t);return o}catch(e){i(loader);console.error("Error loading settings:",e);s(e,"Failed to load settings");const t=document.getElementById("appointmentDate");if(t){t.setAttribute("data-available-days","1,2,3,4,5")}return{}}};const d=async function(e,t){try{const n=r.getSlots(e,t);if(n){u(n);return n}const a=document.getElementById("timeSlots");if(!a)return{available:false,slots:[]};a.innerHTML="<p>Loading available times...</p>";a.classList.add("loading");const o=await c("check_slot_availability");const s=`${massageBookingAPI.restUrl}available-slots?date=${encodeURIComponent(e)}&duration=${encodeURIComponent(t)}`;const l=await fetch(s,{method:"GET",headers:{"X-WP-Nonce":massageBookingAPI.nonce,"X-Booking-Request-Nonce":o,Accept:"application/json"}});a.classList.remove("loading");if(!l.ok){throw new Error(`Failed to load time slots (HTTP ${l.status})`)}let d;try{d=await l.json()}catch(r){console.error("Failed to parse time slots JSON:",r);const e=await l.text();try{const t=e.indexOf("{");if(t>=0){const r=e.substring(t);d=JSON.parse(r)}else{throw new Error("No JSON object found in response")}}catch(e){throw new Error("Invalid response format")}}console.log("Available slots from WordPress:",d);r.setSlots(e,t,d);u(d);return d}catch(r){console.error("Error fetching time slots:",r);const n=document.getElementById("timeSlots");if(n){n.classList.remove("loading");n.innerHTML='\n                        <p>Error loading available times. Please try again.</p>\n                        <button class="retry-button">Retry</button>\n                    ';const a=n.querySelector(".retry-button");if(a){a.addEventListener("click",function(){d(e,t)})}}return{available:false,slots:[]}}};const u=function(e){const t=document.getElementById("timeSlots");if(!t)return;t.innerHTML="";t.classList.remove("loading");if(!e.available||!e.slots||e.slots.length===0){t.innerHTML="<p>No appointments available on this date.</p>";return}e.slots.forEach(e=>{const r=document.createElement("div");r.className="time-slot";r.setAttribute("data-time",e.startTime);r.setAttribute("data-end-time",e.endTime);r.setAttribute("role","option");r.setAttribute("aria-selected","false");r.textContent=e.displayTime;r.addEventListener("click",function(){document.querySelectorAll(".time-slot").forEach(e=>{e.classList.remove("selected");e.setAttribute("aria-selected","false")});this.classList.add("selected");this.setAttribute("aria-selected","true");if(typeof window.updateSummary==="function"){window.updateSummary()}else{f()}try{const t=JSON.parse(sessionStorage.getItem("massageBookingFormData")||"{}");t.selectedTimeSlot=e.startTime;t.selectedEndTime=e.endTime;sessionStorage.setItem("massageBookingFormData",JSON.stringify(t))}catch(e){console.warn("Could not save to session storage:",e)}});t.appendChild(r)})};const f=function(){const e=document.getElementById("bookingSummary");if(!e)return;const t=document.querySelector('input[name="duration"]:checked');const r=document.querySelector(".time-slot.selected");const n=document.getElementById("appointmentDate")?.value;if(t&&r&&n){e.classList.add("visible");const a=t.value;const i=t.closest(".radio-option")?.getAttribute("data-price")||"0";const s=document.getElementById("summaryService");if(s){s.textContent=`${a} Minutes Massage (${i})`}const o=Array.from(document.querySelectorAll('input[name="focus"]:checked')).map(e=>e.value);const c=document.getElementById("summaryFocusAreas");if(c){c.textContent=o.length>0?o.join(", "):"No specific areas selected"}const l=new Date(n).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"});const d=document.getElementById("summaryDateTime");if(d){d.textContent=`${l} at ${r.textContent}`}const u=document.getElementById("summaryPrice");if(u){u.textContent=`${i}`}}else{e.classList.remove("visible")}};const m=function(){let e=true;const r=[];const n=["fullName","email","phone","appointmentDate"];n.forEach(t=>{const n=document.getElementById(t);if(!n||!n.value.trim()){if(n){n.style.borderColor="red";n.setAttribute("aria-invalid","true")}r.push(t.replace(/([A-Z])/g," $1").trim());e=false}else{if(n){n.style.borderColor="";n.removeAttribute("aria-invalid")}}});const a=document.getElementById("email");if(a&&a.value.trim()&&!g(a.value)){a.style.borderColor="red";a.setAttribute("aria-invalid","true");r.push("Valid Email Address");e=false}const i=document.getElementById("phone");if(i&&i.value.trim()&&!h(i.value)){i.style.borderColor="red";i.setAttribute("aria-invalid","true");r.push("Valid Phone Number");e=false}if(!document.querySelector('input[name="duration"]:checked')){const e=document.getElementById("serviceDuration");if(e){e.style.borderColor="red"}r.push("Service Duration");e=false}else{const e=document.getElementById("serviceDuration");if(e){e.style.borderColor=""}}if(!document.querySelector(".time-slot.selected")){const e=document.getElementById("timeSlots");if(e){e.style.borderColor="red"}r.push("Time Slot");e=false}else{const e=document.getElementById("timeSlots");if(e){e.style.borderColor=""}}if(!e){p(r)}return e};const p=function(e){const r=document.querySelectorAll(".validation-errors");r.forEach(e=>e.parentNode.removeChild(e));const n=document.createElement("div");n.className="validation-errors";n.setAttribute("role","alert");n.innerHTML=`\n                <h3>Please fix the following errors:</h3>\n                <ul>${e.map(e=>`<li>${e}</li>`).join("")}</ul>\n            `;if(t.firstChild){t.insertBefore(n,t.firstChild)}else{t.appendChild(n)}n.scrollIntoView({behavior:"smooth",block:"start"});setTimeout(()=>{if(n.parentNode){n.parentNode.removeChild(n)}},8e3)};const g=function(e){const t=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return t.test(String(e).toLowerCase())};const h=function(e){return/^[\d\s()+\-\.]{7,20}$/.test(e)};t.addEventListener("submit",async function(e){e.preventDefault();e.stopPropagation();console.log("Form submission intercepted");if(!m()){console.log("Form validation failed");return false}const t=a();try{const e=y();const r=await b(e);console.log("Appointment successfully created:",r);alert("Your appointment has been booked! A confirmation email will be sent shortly.");v()}catch(e){console.error("Error booking appointment:",e);alert("Error: "+(e.message||"Failed to book appointment"))}finally{i(t)}},true);function y(){const e=document.querySelector(".time-slot.selected");const t=document.querySelector('input[name="duration"]:checked');if(!e||!t){throw new Error("Please select a time slot and service duration.")}const r=Array.from(document.querySelectorAll('input[name="focus"]:checked')).map(e=>e.value);return{action:"massage_booking_create_appointment",nonce:massageBookingAPI.nonce,fullName:document.getElementById("fullName").value,email:document.getElementById("email").value,phone:document.getElementById("phone").value,appointmentDate:document.getElementById("appointmentDate").value,startTime:e.getAttribute("data-time"),endTime:e.getAttribute("data-end-time"),duration:t.value,focusAreas:JSON.stringify(r),pressurePreference:document.getElementById("pressurePreference").value,specialRequests:document.getElementById("specialRequests").value}}function b(e){return new Promise((t,r)=>{$.ajax({url:massageBookingAPI.ajaxUrl,type:"POST",data:e,dataType:"json",timeout:3e4,success:function(e){console.log("AJAX success response",e);if(e.success){t(e.data)}else{r({message:e.data&&e.data.message?e.data.message:"Unknown error occurred",code:e.data&&e.data.code?e.data.code:"unknown_error",data:e.data})}},error:function(e,t,n){console.error("AJAX error",{status:t,error:n,response:e.responseText});let a="Server connection error. Please try again.";let i={};try{const t=JSON.parse(e.responseText);if(t.data&&t.data.message){a=t.data.message}else if(t.message){a=t.message}i=t}catch(t){if(e.status===0){a="Network error. Please check your connection."}else if(e.status===403){a="Permission denied. Please refresh the page and try again."}else if(e.status>=500){a="Server error. Please try again later."}else{a=e.responseText||n||"Unknown error"}}r({message:a,code:t,data:i,xhr:e})}})})}function v(){t.reset();document.querySelectorAll(".radio-option, .checkbox-option, .time-slot").forEach(e=>{e.classList.remove("selected")});const e=document.getElementById("bookingSummary");if(e){e.classList.remove("visible")}const r=document.getElementById("timeSlots");if(r){r.innerHTML="<p>Please select a date to see available time slots.</p>"}const n=document.getElementById("duration60");if(n){n.checked=true;const e=n.closest(".radio-option");if(e){e.classList.add("selected")}}try{sessionStorage.removeItem("massageBookingFormData")}catch(e){console.warn("Failed to clear session storage:",e)}}window.loadSettings=l;window.fetchAvailableTimeSlots=d;window.updateSummary=f;window.validateForm=m;window.resetForm=v;l().then(()=>{console.log("Settings loaded and applied to form");try{const e=sessionStorage.getItem("massageBookingFormData");if(e){const t=JSON.parse(e);if(t.appointmentDate){const e=document.getElementById("appointmentDate");if(e){e.value=t.appointmentDate;const r=new Event("input",{bubbles:true});e.dispatchEvent(r)}}}}catch(e){console.warn("Failed to restore saved form state:",e)}})}});})(jQuery);