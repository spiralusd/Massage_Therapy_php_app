/**
 * Massage Booking - Minimized API Connector
 * Version: 1.0.7
 */
!function(e){e(document).ready(function(){if(console.log("Massage Booking API Connector initialized"),!(t=document.getElementById("appointmentForm"))||void 0===massageBookingAPI)return console.error("Form or API data not found"),void 0;var t,n={settings:null,slots:{},getSettings:function(){return this.settings},setSettings:function(e){return this.settings=e},getSlots:function(e,t){return this.slots[e+"-"+t]},setSlots:function(e,t,n){return this.slots[e+"-"+t]=n},clearCache:function(){this.settings=null,this.slots={}}},o=function(){const e=document.createElement("div");if(e.className="api-loading",e.innerHTML='<div class="loading-spinner"></div><p>Processing...</p>',!document.getElementById("api-loading-styles")){const t=document.createElement("style");t.id="api-loading-styles",t.textContent=".api-loading{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999}.loading-spinner{width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #4a6fa5;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:10px}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}",document.head.appendChild(t)}return e},a=function(e){const t=document.createElement("div");t.className="api-error",t.innerHTML=`
                <p><strong>Error:</strong> ${e.message||"Please try again or contact support."}</p>
                <button class="dismiss-error">Dismiss</button>
            `;const n=document.createElement("style");if(n.id="api-error-styles",n.textContent=".api-error{position:fixed;top:20px;right:20px;max-width:300px;background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;border-radius:4px;padding:15px;z-index:9999;box-shadow:0 2px 10px rgba(0,0,0,0.1)}.dismiss-error{background:#721c24;color:white;border:none;padding:5px 10px;border-radius:3px;cursor:pointer;margin-top:10px}",document.head.appendChild(n),t.querySelector(".dismiss-error").addEventListener("click",()=>{t.parentNode&&t.parentNode.removeChild(t)}),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},1e4),document.body.appendChild(t),!1),i=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),r=e=>/^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/.test(e),s=()=>{const e=[],t=document.getElementById("fullName"),n=document.getElementById("email"),o=document.getElementById("phone"),a=document.getElementById("appointmentDate"),s=document.querySelector('input[name="duration"]:checked'),l=document.querySelector(".time-slot.selected"),c=e=>{const t=e.value.trim();return!!t};if(!c(t)&&(e.push("Please enter your full name"),t.style.borderColor="red",t.setAttribute("aria-invalid","true")),!c(n)&&(e.push(i(n.value)?"Please enter a valid email address":"Please enter your email address"),n.style.borderColor="red",n.setAttribute("aria-invalid","true")),!c(o)&&(e.push(r(o.value)?"Please enter a valid phone number":"Please enter your phone number"),o.style.borderColor="red",o.setAttribute("aria-invalid","true")),!a.value&&(e.push("Please select an appointment date"),a.style.borderColor="red",a.setAttribute("aria-invalid","true")),!s&&e.push("Please select a service duration"),!l&&e.push("Please select an appointment time"),e.length){const t=document.createElement("div");t.className="validation-errors",t.setAttribute("role","alert"),t.innerHTML=`
                    <h3>Please fix the following errors:</h3>
                    <ul>${e.map(e=>`<li>${e}</li>`).join("")}</ul>
                `;const n=document.createElement("style");return n.textContent=".validation-errors{background-color:#f8d7da;color:#721c24;padding:15px;margin-bottom:20px;border:1px solid #f5c6cb;border-radius:4px}",document.head.appendChild(n),document.getElementById("appointmentForm").insertBefore(t,document.getElementById("appointmentForm").firstChild),t.scrollIntoView({behavior:"smooth"}),!1}return!0},l=async()=>{try{const e=await fetch(massageBookingAPI.restUrl+"settings",{method:"GET",headers:{"X-WP-Nonce":massageBookingAPI.nonce,Accept:"application/json"}});if(!e.ok)throw new Error(`Failed to load settings (HTTP ${e.status})`);const t=await e.json();console.log("Settings loaded from WordPress:",t);const n=document.getElementById("appointmentDate");if(n&&(n.setAttribute("data-available-days",t.working_days.join(",")),t.working_days)){const e={0:"Sunday",1:"Monday",2:"Tuesday",3:"Wednesday",4:"Thursday",5:"Friday",6:"Saturday"},o=t.working_days.map(t=>e[t]).join(", "),a=document.querySelector("#appointmentDate + small");a&&(a.textContent="Available days: "+o)}return t}catch(e){return console.error("Error loading settings:",e),{}}},c=async(e,t)=>{try{const n=await fetch(`${massageBookingAPI.restUrl}available-slots?date=${encodeURIComponent(e)}&duration=${encodeURIComponent(t)}`,{method:"GET",headers:{"X-WP-Nonce":massageBookingAPI.nonce,Accept:"application/json"}});if(!n.ok)throw new Error(`Failed to load time slots (HTTP ${n.status})`);const o=await n.json();return((e,t)=>{const n=document.getElementById("timeSlots");if(n.innerHTML="",!e.available||!e.slots||0===e.slots.length)return void(n.innerHTML="<p>No appointments available on this date.</p>");e.slots.forEach(e=>{const t=document.createElement("div");t.className="time-slot",t.setAttribute("data-time",e.startTime),t.setAttribute("data-end-time",e.endTime),t.setAttribute("role","option"),t.setAttribute("aria-selected","false"),t.textContent=e.displayTime,t.addEventListener("click",function(){document.querySelectorAll(".time-slot").forEach(e=>{e.classList.remove("selected"),e.setAttribute("aria-selected","false")}),this.classList.add("selected"),this.setAttribute("aria-selected","true"),window.updateSummary&&window.updateSummary(),"function"==typeof sessionStorage.setItem&&sessionStorage.setItem("massageBookingFormData",JSON.stringify({selectedTimeSlot:e.startTime,selectedEndTime:e.endTime}))},n.appendChild(t))})})(o),o}catch(e){return console.error("Error fetching time slots:",e),{available:!1,slots:[]}}};t.addEventListener("submit",async function(e){if(e.preventDefault(),!s())return;const t=o();try{const e=document.querySelector(".time-slot.selected"),n=document.querySelector('input[name="duration"]:checked');if(!e||!n)throw new Error("Please select a time slot and service duration.");const a=Array.from(document.querySelectorAll('input[name="focus"]:checked')).map(e=>e.value),i={action:"massage_booking_create_appointment",nonce:massageBookingAPI.nonce,fullName:document.getElementById("fullName").value,email:document.getElementById("email").value,phone:document.getElementById("phone").value,appointmentDate:document.getElementById("appointmentDate").value,startTime:e.getAttribute("data-time"),endTime:e.getAttribute("data-end-time"),duration:n.value,focusAreas:JSON.stringify(a),pressurePreference:document.getElementById("pressurePreference").value,specialRequests:document.getElementById("specialRequests").value};try{const e=await $.ajax({url:massageBookingAPI.ajaxUrl,type:"POST",data:i,dataType:"json",timeout:3e4});if(!e.success)throw new Error(e.data.message||"Booking failed");alert("Your appointment has been booked! A confirmation email will be sent shortly."),t.reset(),document.querySelectorAll(".radio-option, .checkbox-option, .time-slot").forEach(e=>e.classList.remove("selected")),document.getElementById("bookingSummary").classList.remove("visible"),document.getElementById("timeSlots").innerHTML='<p>Please select a date to see available time slots.</p>',sessionStorage.removeItem("massageBookingFormData");const n=document.getElementById("duration60");if(n){n.checked=!0;const e=n.closest(".radio-option");e&&e.classList.add("selected")}}catch(e){console.error("Error booking appointment:",e),alert("Error: "+(e.message||"Failed to book appointment"))}finally{((e,t)=>{e&&e.parentNode&&e.parentNode.removeChild(e)})(t)}},!0);window.loadSettings=l,window.fetchAvailableTimeSlots=c,l().then(()=>{console.log("Settings loaded and applied to form");try{const e=sessionStorage.getItem("massageBookingFormData");if(e){const t=JSON.parse(e);if(t.appointmentDate){const e=document.getElementById("appointmentDate");e.value=t.appointmentDate;const n=new Event("input",{bubbles:!0});e.dispatchEvent(n)}}}catch(e){console.warn("Failed to restore saved form state:",e)}})})}(jQuery);