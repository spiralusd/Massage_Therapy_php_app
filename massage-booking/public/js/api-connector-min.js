jQuery(document).ready(function(e){console.log("Massage Booking API Connector initialized");const t=document.getElementById("appointmentForm");if(!t)return void console.error("Appointment form not found");if("undefined"==typeof massageBookingAPI)return void console.error("WordPress API data not available");const n=window.loadSettings,o=window.fetchAvailableTimeSlots,a=window.updateSummary,r=()=>{const e=document.createElement("div");e.className="api-loading",e.innerHTML='\n            <div class="loading-spinner"></div>\n            <p>Processing...</p>\n        ';const t=document.createElement("style");return t.textContent="\n            .api-loading {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(255, 255, 255, 0.8);\n                display: flex;\n                flex-direction: column;\n                justify-content: center;\n                align-items: center;\n                z-index: 9999;\n            }\n            .loading-spinner {\n                width: 40px;\n                height: 40px;\n                border: 4px solid #f3f3f3;\n                border-top: 4px solid #4a6fa5;\n                border-radius: 50%;\n                animation: spin 1s linear infinite;\n                margin-bottom: 10px;\n            }\n            @keyframes spin {\n                0% { transform: rotate(0deg); }\n                100% { transform: rotate(360deg); }\n            }\n        ",document.head.appendChild(t),e},i=()=>{const e=r();return document.body.appendChild(e),e},s=e=>{e&&e.parentNode&&e.parentNode.removeChild(e)},l=(e,t="An error occurred")=>{console.error(e);const n=document.createElement("div");n.className="api-error",n.innerHTML=`\n            <p><strong>Error:</strong> ${t}</p>\n            <p>${e.message||"Please try again or contact support."}</p>\n            <button class="dismiss-error">Dismiss</button>\n        `;const o=document.createElement("style");o.textContent="\n            .api-error {\n                position: fixed;\n                top: 20px;\n                right: 20px;\n                max-width: 300px;\n                background: #f8d7da;\n                color: #721c24;\n                border: 1px solid #f5c6cb;\n                border-radius: 4px;\n                padding: 15px;\n                z-index: 9999;\n                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);\n            }\n            .dismiss-error {\n                background: #721c24;\n                color: white;\n                border: none;\n                padding: 5px 10px;\n                border-radius: 3px;\n                cursor: pointer;\n                margin-top: 10px;\n            }\n        ",document.head.appendChild(o),n.querySelector(".dismiss-error").addEventListener("click",()=>{n.parentNode&&n.parentNode.removeChild(n)}),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},5e3),!1}return!0}(()=>{n.parentNode&&n.parentNode.removeChild(n)},1e4),document.body.appendChild(n)},c={settings:null,slots:{},getSettings:function(){return this.settings},setSettings:function(e){return this.settings=e,e},getSlots:function(e,t){return this.slots[`${e}-${t}`]},setSlots:function(e,t,n){return this.slots[`${e}-${t}`]=n,n},clearCache:function(){this.settings=null,this.slots={}}};window.loadSettings=async function(){try{const e=c.getSettings();if(e)return e;const t=i(),o=await fetch(massageBookingAPI.restUrl+"settings",{method:"GET",headers:{"X-WP-Nonce":massageBookingAPI.nonce}});if(!o.ok)throw new Error(`Failed to load settings (HTTP ${o.status})`);const a=await o.json();if(console.log("Settings loaded from WordPress:",a),c.setSettings(a),a.working_days){document.getElementById("appointmentDate").setAttribute("data-available-days",a.working_days.join(","));const e={0:"Sunday",1:"Monday",2:"Tuesday",3:"Wednesday",4:"Thursday",5:"Friday",6:"Saturday"},t=a.working_days.map(t=>e[t]).join(", "),n=document.querySelector("#appointmentDate + small");n&&(n.textContent="Available days: "+t)}if(a.durations){document.querySelectorAll(".radio-option").forEach(e=>{const t=e.getAttribute("data-value");a.durations.includes(t)?(e.style.display="block",a.prices&&a.prices[t]&&(e.querySelector(".price").textContent="$"+a.prices[t])):e.style.display="none"})}if(a.break_time){const e=document.querySelector(".privacy-notice p");e&&(e.innerHTML=e.innerHTML.replace(/\d+-minute break/,a.break_time+"-minute break"))}return"function"==typeof window.setAvailableDays&&window.setAvailableDays(),s(t),a}catch(e){throw s(t),l(e,"Failed to load settings"),"function"==typeof n?n():(document.getElementById("appointmentDate").setAttribute("data-available-days","1,2,3,4,5"),{})}},window.fetchAvailableTimeSlots=async function(e,t){try{const n=c.getSlots(e,t);if(n)return d(n),n;document.getElementById("timeSlots").innerHTML="<p>Loading available times...</p>";const a=await async function(e){try{const t=await fetch(massageBookingAPI.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"generate_booking_nonce",booking_action:e,_wpnonce:massageBookingAPI.nonce})});if(!t.ok)throw new Error("Failed to generate nonce");const n=await t.json();return n.nonce||""}catch(e){return console.error("Error generating nonce:",e),""}}("check_time_slots"),r=await fetch(`${massageBookingAPI.restUrl}available-slots?date=${e}&duration=${t}`,{method:"GET",headers:{"X-WP-Nonce":massageBookingAPI.nonce,"X-Booking-Request-Nonce":a}});if(!r.ok)throw new Error(`Failed to load time slots (HTTP ${r.status})`);const i=await r.json();return console.log("Available slots from WordPress:",i),c.setSlots(e,t,i),d(i),i}catch(n){console.error("Error fetching time slots from WordPress:",n);const a=document.getElementById("timeSlots");return a.innerHTML='\n                <p>Error loading available times. Please try again.</p>\n                <button class="retry-button">Retry</button>\n            ',a.querySelector(".retry-button")?.addEventListener("click",()=>{window.fetchAvailableTimeSlots(e,t)}),"function"==typeof o?o(e,t):{available:!1,slots:[]}}};const d=e=>{const t=document.getElementById("timeSlots");if(t.innerHTML="",!e.available||!e.slots||0===e.slots.length)return void(t.innerHTML="<p>No appointments available on this date.</p>");e.slots.forEach(e=>{const n=document.createElement("div");n.className="time-slot",n.setAttribute("data-time",e.startTime),n.setAttribute("data-end-time",e.endTime),n.setAttribute("role","option"),n.setAttribute("aria-selected","false"),n.textContent=e.displayTime,n.addEventListener("click",function(){document.querySelectorAll(".time-slot").forEach(e=>{e.classList.remove("selected"),e.setAttribute("aria-selected","false")}),this.classList.add("selected"),this.setAttribute("aria-selected","true"),"function"==typeof window.updateSummary&&window.updateSummary();const t=JSON.parse(sessionStorage.getItem("massageBookingFormData")||"{}");t.selectedTimeSlot=e.startTime,sessionStorage.setItem("massageBookingFormData",JSON.stringify(t))}),t.appendChild(n)})};function m(e){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(e).toLowerCase())}function p(e){return/^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/.test(String(e))}function u(){const e=[];document.getElementById("fullName").value.trim()?(document.getElementById("fullName").style.borderColor="",document.getElementById("fullName").removeAttribute("aria-invalid")):(e.push("Please enter your full name"),document.getElementById("fullName").style.borderColor="red",document.getElementById("fullName").setAttribute("aria-invalid","true"));const t=document.getElementById("email");t.value.trim()?m(t.value)?(t.style.borderColor="",t.removeAttribute("aria-invalid")):(e.push("Please enter a valid email address"),t.style.borderColor="red",t.setAttribute("aria-invalid","true")):(e.push("Please enter your email address"),t.style.borderColor="red",t.setAttribute("aria-invalid","true"));const n=document.getElementById("phone");n.value.trim()?p(n.value)?(n.style.borderColor="",n.removeAttribute("aria-invalid")):(e.push("Please enter a valid phone number"),n.style.borderColor="red",n.setAttribute("aria-invalid","true")):(e.push("Please enter your phone number"),n.style.borderColor="red",n.setAttribute("aria-invalid","true"));document.getElementById("appointmentDate").value?(document.getElementById("appointmentDate").style.borderColor="",document.getElementById("appointmentDate").removeAttribute("aria-invalid")):(e.push("Please select an appointment date"),document.getElementById("appointmentDate").style.borderColor="red",document.getElementById("appointmentDate").setAttribute("aria-invalid","true")),document.querySelector('input[name="duration"]:checked')?(document.getElementById("serviceDuration").style.borderColor=""):(e.push("Please select a service duration"),document.getElementById("serviceDuration").style.borderColor="red"),document.querySelector(".time-slot.selected")?(document.getElementById("timeSlots").style.borderColor=""):(e.push("Please select an appointment time"),document.getElementById("timeSlots").style.borderColor="red");if(e.length>0){const t=document.createElement("div");t.className="validation-errors",t.setAttribute("role","alert"),t.innerHTML=`\n                <h3>Please fix the following errors:</h3>\n                <ul>${e.map(e=>`<li>${e}</li>`).join("")}</ul>\n            `;const n=document.createElement("style");n.textContent="\n                .validation-errors {\n                    background-color: #f8d7da;\n                    color: #721c24;\n                    padding: 15px;\n                    margin-bottom: 20px;\n                    border: 1px solid #f5c6cb;\n                    border-radius: 4px;\n                }\n                .validation-errors ul {\n                    margin-top: 10px;\n                    padding-left: 20px;\n                }\n            ",document.head.appendChild(n);const o=document.getElementById("appointmentForm");o.firstChild?o.insertBefore(t,o.firstChild):o.appendChild(t),t.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout